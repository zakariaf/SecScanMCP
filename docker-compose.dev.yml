# Development override for docker-compose
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  scanner:
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - LOG_LEVEL=DEBUG
      - RELOAD=true  # Auto-reload on code changes
    volumes:
      # Mount source code for hot reloading
      - ./app:/app/app:ro
      - ./analyzers:/app/analyzers:ro
      - ./main.py:/app/main.py:ro
      - ./scanner.py:/app/scanner.py:ro
      - ./models.py:/app/models.py:ro
      - ./scoring.py:/app/scoring.py:ro
      # Cache volume
      - scanner-cache:/home/scanner/.cache
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Run examples
  example-runner:
    build: .
    volumes:
      - ./examples:/app/examples
      - ./security_report_*.json:/app/
    working_dir: /app
    command: python examples/scan_example.py ${REPO_URL:-https://github.com/user/repo}
    profiles:
      - examples
    depends_on:
      - scanner

  # Development shell
  dev-shell:
    build: .
    volumes:
      - .:/app
      - scanner-cache:/home/scanner/.cache
    working_dir: /app
    command: /bin/bash
    profiles:
      - dev
    stdin_open: true
    tty: true

  # Tool versions checker
  tool-versions:
    build: .
    command: |
      sh -c "
        echo '=== Installed Tool Versions ==='
        echo 'Trivy:' && trivy --version
        echo ''
        echo 'Grype:' && grype version
        echo ''
        echo 'Syft:' && syft version
        echo ''
        echo 'TruffleHog:' && trufflehog --version
        echo ''
        echo 'Bandit:' && bandit --version
        echo ''
        echo 'Semgrep:' && semgrep --version
      "
    profiles:
      - tools

volumes:
  scanner-cache: