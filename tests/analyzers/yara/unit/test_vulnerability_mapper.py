"""Tests for VulnerabilityMapperService"""

from analyzers.security_tools.yara.services.vulnerability_mapper import (
    VulnerabilityMapperService, SEVERITY_MAP, VULNERABILITY_TYPE_MAP
)
from models import SeverityLevel, VulnerabilityType


def test_severity_critical():
    """Test critical severity mapping"""
    svc = VulnerabilityMapperService()
    meta = {'severity': 'critical'}
    assert svc.determine_severity(meta) == SeverityLevel.CRITICAL


def test_severity_high():
    """Test high severity mapping"""
    svc = VulnerabilityMapperService()
    meta = {'severity': 'high'}
    assert svc.determine_severity(meta) == SeverityLevel.HIGH


def test_severity_case_insensitive():
    """Test severity mapping is case insensitive"""
    svc = VulnerabilityMapperService()
    assert svc.determine_severity({'severity': 'HIGH'}) == SeverityLevel.HIGH
    assert svc.determine_severity({'severity': 'Critical'}) == SeverityLevel.CRITICAL


def test_severity_default():
    """Test default severity when not specified"""
    svc = VulnerabilityMapperService()
    assert svc.determine_severity({}) == SeverityLevel.MEDIUM


def test_severity_unknown():
    """Test unknown severity falls back to medium"""
    svc = VulnerabilityMapperService()
    meta = {'severity': 'unknown_level'}
    assert svc.determine_severity(meta) == SeverityLevel.MEDIUM


def test_vuln_type_malware():
    """Test malware vulnerability type mapping"""
    svc = VulnerabilityMapperService()
    meta = {'category': 'malware'}
    assert svc.determine_vuln_type(meta) == VulnerabilityType.MALWARE


def test_vuln_type_sql_injection():
    """Test SQL injection mapping"""
    svc = VulnerabilityMapperService()
    meta = {'category': 'sql_injection'}
    assert svc.determine_vuln_type(meta) == VulnerabilityType.SQL_INJECTION


def test_vuln_type_mcp_specific():
    """Test MCP-specific vulnerability types"""
    svc = VulnerabilityMapperService()
    assert svc.determine_vuln_type({'category': 'mcp_threats'}) == VulnerabilityType.MCP_SPECIFIC
    assert svc.determine_vuln_type({'category': 'mcp_specific'}) == VulnerabilityType.MCP_SPECIFIC


def test_vuln_type_default():
    """Test default vulnerability type"""
    svc = VulnerabilityMapperService()
    assert svc.determine_vuln_type({}) == VulnerabilityType.GENERIC


def test_vuln_type_case_insensitive():
    """Test category mapping is case insensitive"""
    svc = VulnerabilityMapperService()
    assert svc.determine_vuln_type({'category': 'MALWARE'}) == VulnerabilityType.MALWARE


def test_extract_references_with_author():
    """Test reference extraction with author"""
    svc = VulnerabilityMapperService()
    meta = {'author': 'Security Team'}
    refs = svc.extract_references(meta)
    assert 'Rule author: Security Team' in refs


def test_extract_references_with_urls():
    """Test reference extraction with URLs"""
    svc = VulnerabilityMapperService()
    meta = {
        'reference': 'https://example.com/cve',
        'other_url': 'https://owasp.org/vuln'
    }
    refs = svc.extract_references(meta)
    assert 'https://example.com/cve' in refs
    assert 'https://owasp.org/vuln' in refs


def test_extract_references_ignores_non_urls():
    """Test that non-URL values are not included as references"""
    svc = VulnerabilityMapperService()
    meta = {'description': 'This is not a URL', 'severity': 'high'}
    refs = svc.extract_references(meta)
    assert 'This is not a URL' not in refs


def test_get_confidence_from_meta():
    """Test confidence extraction from metadata"""
    svc = VulnerabilityMapperService()
    meta = {'confidence': 0.95}
    assert svc.get_confidence(meta) == 0.95


def test_get_confidence_default():
    """Test default confidence"""
    svc = VulnerabilityMapperService()
    assert svc.get_confidence({}) == 0.8


def test_get_recommendation_from_meta():
    """Test recommendation extraction from metadata"""
    svc = VulnerabilityMapperService()
    meta = {'recommendation': 'Remove the malicious code'}
    assert svc.get_recommendation(meta) == 'Remove the malicious code'


def test_get_recommendation_default():
    """Test default recommendation"""
    svc = VulnerabilityMapperService()
    rec = svc.get_recommendation({})
    assert 'Review the detected pattern' in rec


def test_all_severity_levels_mapped():
    """Ensure all severity levels in map return correct values"""
    svc = VulnerabilityMapperService()
    for key, expected in SEVERITY_MAP.items():
        assert svc.determine_severity({'severity': key}) == expected


def test_all_vuln_types_mapped():
    """Ensure all vulnerability types in map return correct values"""
    svc = VulnerabilityMapperService()
    for key, expected in VULNERABILITY_TYPE_MAP.items():
        assert svc.determine_vuln_type({'category': key}) == expected
