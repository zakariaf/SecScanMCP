"""
YARA Vulnerability Mapper Service

Maps YARA rule metadata to severity levels and vulnerability types
"""

from typing import Any, Dict, List

from models import SeverityLevel, VulnerabilityType


# Severity mapping from rule metadata
SEVERITY_MAP = {
    'critical': SeverityLevel.CRITICAL,
    'high': SeverityLevel.HIGH,
    'medium': SeverityLevel.MEDIUM,
    'low': SeverityLevel.LOW,
    'info': SeverityLevel.INFO
}

# Vulnerability type mapping from rule category
VULNERABILITY_TYPE_MAP = {
    'malware': VulnerabilityType.MALWARE,
    'backdoor': VulnerabilityType.BACKDOOR,
    'trojan': VulnerabilityType.BACKDOOR,
    'injection': VulnerabilityType.COMMAND_INJECTION,
    'command_injection': VulnerabilityType.COMMAND_INJECTION,
    'sql_injection': VulnerabilityType.SQL_INJECTION,
    'script_injection': VulnerabilityType.XSS,
    'xss': VulnerabilityType.XSS,
    'credential': VulnerabilityType.HARDCODED_SECRET,
    'credential_harvesting': VulnerabilityType.HARDCODED_SECRET,
    'secret': VulnerabilityType.HARDCODED_SECRET,
    'crypto': VulnerabilityType.WEAK_CRYPTO,
    'permission': VulnerabilityType.PRIVILEGE_ESCALATION,
    'system_manipulation': VulnerabilityType.PRIVILEGE_ESCALATION,
    'path_traversal': VulnerabilityType.PATH_TRAVERSAL,
    'mcp_threats': VulnerabilityType.MCP_SPECIFIC,
    'mcp_specific': VulnerabilityType.MCP_SPECIFIC,
    'coercive_injection': VulnerabilityType.PROMPT_INJECTION,
    'prompt_injection': VulnerabilityType.PROMPT_INJECTION,
    'tool_manipulation': VulnerabilityType.TOOL_MANIPULATION,
    'code_execution': VulnerabilityType.COMMAND_INJECTION,
    'nosql_injection': VulnerabilityType.SQL_INJECTION,
    'template_injection': VulnerabilityType.XSS
}


class VulnerabilityMapperService:
    """Maps YARA metadata to vulnerability classifications"""

    def determine_severity(self, meta: Dict[str, Any]) -> SeverityLevel:
        """Determine severity from rule metadata"""
        severity_str = meta.get('severity', 'medium').lower()
        return SEVERITY_MAP.get(severity_str, SeverityLevel.MEDIUM)

    def determine_vuln_type(self, meta: Dict[str, Any]) -> VulnerabilityType:
        """Determine vulnerability type from rule metadata"""
        category = meta.get('category', '').lower()
        return VULNERABILITY_TYPE_MAP.get(category, VulnerabilityType.GENERIC)

    def extract_references(self, meta: Dict[str, Any]) -> List[str]:
        """Extract references from rule metadata"""
        references = []

        if 'author' in meta:
            references.append(f"Rule author: {meta['author']}")

        for key, value in meta.items():
            if isinstance(value, str) and self._is_url(value):
                references.append(value)

        return references

    def _is_url(self, value: str) -> bool:
        """Check if value is a URL"""
        return value.startswith(('http://', 'https://'))

    def get_confidence(self, meta: Dict[str, Any]) -> float:
        """Get confidence score from metadata"""
        return float(meta.get('confidence', 0.8))

    def get_recommendation(self, meta: Dict[str, Any]) -> str:
        """Get recommendation from metadata"""
        default = 'Review the detected pattern and take appropriate action'
        return meta.get('recommendation', default)
