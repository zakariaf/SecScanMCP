"""Vulnerability response checking utilities."""

from typing import Optional
from ..transports.base_transport import MCPResponse


class VulnerabilityChecker:
    """Checks responses for vulnerability indicators."""

    COMMAND_INJECTION_INDICATORS = [
        "uid=", "gid=", "root", "administrator",
        "/bin/", "/usr/bin/", "command not found", "no such file",
    ]

    PATH_TRAVERSAL_INDICATORS = [
        "root:x:", "daemon:x:", "[boot loader]",
        "[operating systems]", "# host database", "permission denied",
    ]

    CODE_INJECTION_INDICATORS = [
        "42", "traceback", "syntaxerror", "referenceerror",
    ]

    PROMPT_INJECTION_INDICATORS = [
        "pwned", "admin mode", "developer mode", "ignore",
        "previous instructions", "system override", "no restrictions",
        "safety restrictions", "content filters",
    ]

    UNAUTHORIZED_ACCESS_INDICATORS = [
        "root:x:", "daemon:x:", "api_key", "secret_key",
        "password", "[boot loader]", "database_url", "mongodb_uri",
    ]

    @classmethod
    def check_response(cls, response: MCPResponse, vuln_type: str) -> bool:
        """Check if response indicates vulnerability."""
        if not response:
            return False
        text = cls._get_response_text(response)
        indicators = cls._get_indicators(vuln_type)
        return any(ind in text for ind in indicators)

    @classmethod
    def _get_response_text(cls, response: MCPResponse) -> str:
        """Extract text from response."""
        if response.result:
            return str(response.result).lower()
        if response.error:
            return str(response.error).lower()
        return ""

    @classmethod
    def _get_indicators(cls, vuln_type: str) -> list:
        """Get indicators for vulnerability type."""
        indicator_map = {
            "command_injection": cls.COMMAND_INJECTION_INDICATORS,
            "path_traversal": cls.PATH_TRAVERSAL_INDICATORS,
            "code_injection": cls.CODE_INJECTION_INDICATORS,
            "prompt_injection": cls.PROMPT_INJECTION_INDICATORS,
            "unauthorized_resource_access": cls.UNAUTHORIZED_ACCESS_INDICATORS,
        }
        return indicator_map.get(vuln_type, [])
